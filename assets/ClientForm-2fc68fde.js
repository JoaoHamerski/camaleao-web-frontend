import{G as m,C as p,U as u}from"./Client-cfdef3aa.js";import{G as h}from"./City-ae18d4e9.js";import{G as f}from"./Resources-b591129f.js";import{G as _,d as b}from"./ShippingCompany-204ada3f.js";import{aZ as g,a_ as C,a$ as v,aE as y,n as L,a5 as $,F as A,s as l,u as c,_ as k}from"./index-fae63e1f.js";import{d as E}from"./Order-7b0e72c5.js";import{c as w,a as F}from"./masks-168ccaff.js";function x(i,e){for(var t=-1,a=i==null?0:i.length;++t<a;)if(!e(i[t],t,i))return!1;return!0}function B(i,e){var t=!0;return g(i,function(a,r,s){return t=!!e(a,r,s),t}),t}function S(i,e,t){var a=C(i)?x:B;return t&&v(i,e,t)&&(e=void 0),a(i,y(e))}const G={apollo:{cities:{query:h,variables:{orderBy:[{column:"NAME",order:"ASC"}]},result({loading:i}){i||(this.loaded.cities=!0)}},branches:{query:_,result({data:i,loading:e}){e||(this.branches=i.branches.filter(t=>!!t.city),this.loaded.branches=!0)}},shippingCompanies:{query:b,result({loading:i}){i||(this.loaded.shippingCompanies=!0)}}},props:{client:{type:Object,default:null},isEdit:{type:Boolean,default:!1}},data(){return{maskPhone:w,isLoading:!1,isClientLoading:!1,cities:[],branches:[],shippingCompanies:[],clients:[],roles:$,loaded:{cities:!1,branches:!1,shippingCompanies:!1},form:new A({name:"",phone:"",city_id:"",branch_id:"",client_recommended_id:"",bonus:"R$ 0,00"}),maskCurrencyBRL:F()}},computed:{isQueryLoading(){return!!this.$apollo.loading}},watch:{loaded:{immediate:!0,deep:!0,handler(i){const e=S({...i},t=>t===!0);this.isEdit&&e&&this.populateForm()}}},mounted(){var i;(i=this.client)!=null&&i.client_recommended||(this.loaded.client=!0)},methods:{async findClients(i){const e=i.match(/^\d/)?"PHONE":"NAME";this.isClientLoading=!0;const{data:t}=await this.$apollo.query({query:m,variables:{first:10,where:{column:e,operator:"LIKE",value:`%${i}%`}}});this.isClientLoading=!1,this.clients=t.clients.data},populateForm(){const{name:i,phone:e,city:t,branch:a,shipping_company:r,is_sponsor:s,client_recommended:o,bonus:d}=this.client;this.form.name=i,this.form.phone=e,this.form.is_sponsor=!!s,this.form.bonus=this.$helpers.toBRL(d),t&&(this.form.city_id=this.cities.find(({id:n})=>t.id===n),this.cities.find(({id:n})=>t.id===n)),a&&(this.form.branch_id=this.branches.find(({id:n})=>a.id===n)),r&&(this.form.shipping_company_id=this.shippingCompanies.find(({id:n})=>r.id===n)),o&&(this.form.client_recommended_id=o)},getFormattedData(){var e,t,a,r;const i=this.form.data();return i.city_id=((e=i.city_id)==null?void 0:e.id)||"",i.branch_id=((t=i.branch_id)==null?void 0:t.id)||"",i.shipping_company_id=((a=i.shipping_company_id)==null?void 0:a.id)||"",i.client_recommended_id=((r=i.client_recommended_id)==null?void 0:r.id)||"",i},async create(i){try{await this.$apollo.mutate({mutation:p,variables:{input:i},refetchQueries:[{query:f,variables:{where:{column:"CITY_ID",operator:"EQ",value:i.city_id}}}]}),this.$helpers.clearCacheFrom({fieldName:"clients"}),l(this,{message:"Cliente cadastrado!",resetForm:!0})}catch(e){c(this,e)}},async update(i){try{await this.$apollo.mutate({mutation:u,variables:{id:this.client.id,input:i},refetchQueries:[E]}),l(this,{message:"Cliente atualizado!"})}catch(e){c(this,e)}},async onSubmit(){const i=this.getFormattedData();this.isLoading=!0,this.isEdit?await this.update(i):await this.create(i),this.isLoading=!1},customLabelCity({name:i,state:e}){return e===null?i:`${i} - ${e.abbreviation}`},customLabelBranch({city:i}){if(!i)return"N/A";const{state:e}=i;return e===null?i.name:`${i.name} - ${e.abbreviation}`},customLabelClient({name:i,phone:e}){return e?`${i} - ${k(e)}`:i},onCitySelected(i){this.form.branch_id=this.branches.find(e=>{var t;return e.id===((t=i==null?void 0:i.branch)==null?void 0:t.id)||""}),this.form.shipping_company_id=this.shippingCompanies.find(e=>{var t,a;return e.id===((a=(t=i.branch)==null?void 0:t.shipping_company)==null?void 0:a.id)||""})}}};var I=function(){var e=this,t=e._self._c;return t("AppForm",{attrs:{"on-submit":e.onSubmit,form:e.form}},[t("AppLoading",{directives:[{name:"show",rawName:"v-show",value:e.isQueryLoading,expression:"isQueryLoading"}]}),t("AppInput",{attrs:{id:"name",name:"name",placeholder:"Digite o nome...",error:e.form.errors.get("name")},model:{value:e.form.name,callback:function(a){e.$set(e.form,"name",a)},expression:"form.name"}},[e._v(" Nome ")]),t("AppInput",{attrs:{id:"phone",optional:"",name:"phone",mask:e.maskPhone,error:e.form.errors.get("phone"),placeholder:"Digite o telefone..."},model:{value:e.form.phone,callback:function(a){e.$set(e.form,"phone",a)},expression:"form.phone"}},[e._v(" Telefone ")]),t("AppSelect",{attrs:{name:"city_id",error:e.form.errors.get("city_id"),options:e.cities,"custom-label":e.customLabelCity,optional:""},on:{input:e.onCitySelected},scopedSlots:e._u([{key:"hint",fn:function(){return[e._v(" Ao selecionar a "),t("b",[e._v("Cidade")]),e._v(", a "),t("b",[e._v("Filial")]),e._v(" e "),t("b",[e._v("Transportadora")]),e._v(" serão preenchidos automaticamente caso haja algum dado relacionado. ")]},proxy:!0}]),model:{value:e.form.city_id,callback:function(a){e.$set(e.form,"city_id",a)},expression:"form.city_id"}},[e._v(" Cidade ")]),t("AppSelect",{attrs:{name:"branch_id",error:e.form.errors.get("branch_id"),options:e.branches,"custom-label":e.customLabelBranch,optional:""},model:{value:e.form.branch_id,callback:function(a){e.$set(e.form,"branch_id",a)},expression:"form.branch_id"}},[e._v(" Filial ")]),t("AppSelect",{attrs:{name:"shipping_company_id",error:e.form.errors.get("shipping_company_id"),options:e.shippingCompanies,"custom-label":({name:a})=>a,optional:""},model:{value:e.form.shipping_company_id,callback:function(a){e.$set(e.form,"shipping_company_id",a)},expression:"form.shipping_company_id"}},[e._v(" Frete - Transportadora ")]),t("AppSelect",{attrs:{name:"client_recommended_id",options:e.clients,error:e.form.errors.get("client_recommended_id"),optional:"","custom-label":e.customLabelClient,loading:e.isClientLoading},on:{"search-change":e.findClients},model:{value:e.form.client_recommended_id,callback:function(a){e.$set(e.form,"client_recommended_id",a)},expression:"form.client_recommended_id"}},[e._v(" Cliente que indicou ")]),e.isEdit&&e.$helpers.canView(e.roles.GERENCIA)?t("AppInput",{attrs:{name:"bonus",placeholder:"Alterar bônus do cliente...",mask:e.maskCurrencyBRL},model:{value:e.form.bonus,callback:function(a){e.$set(e.form,"bonus",a)},expression:"form.bonus"}},[e._v(" Bônus ")]):e._e(),t("div",{staticClass:"row"},[t("div",{staticClass:"col"},[t("AppButton",{staticClass:"fw-bold",attrs:{loading:e.isLoading,type:"submit",color:"success",block:""}},[e._v(" "+e._s(e.isEdit?"Atualizar":"Cadastrar")+" ")])],1),t("div",{staticClass:"col"},[t("AppButton",{attrs:{type:"button",color:"light","data-bs-dismiss":"modal",block:"",disabled:e.isLoading}},[e._v(" Cancelar ")])],1)])],1)},N=[],q=L(G,I,N,!1,null,null,null,null);const O=q.exports;export{O as C};
