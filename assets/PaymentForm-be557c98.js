import{n as l,H as m,F as d,i as o,bC as c,r,N as p,s as i,u as n}from"./index-fae63e1f.js";import{G as u}from"./Via-eb0eedf9.js";import{a as _,U as f}from"./Payment-7f758fb7.js";import{S as h,e as v}from"./SelectEntriesFind-e5d39e3c.js";import{a as b,m as y}from"./masks-168ccaff.js";import{S as k}from"./SelectClientsFind-0687f9cc.js";import"./_PaginatorFragment-c01a3fe7.js";import"./Resources-b591129f.js";const g={components:{SelectClientsFind:k,SelectEntriesFind:h},apollo:{vias:{query:u}},props:{order:{type:Object,default:()=>{}},payment:{type:Object,default:()=>{}},isEdit:{type:Boolean,default:!1}},data(){return{icons:{faQuestionCircle:m},vias:[],clients:{items:[],isLoading:!1},bank_entry:"",form:new d({bank_uid:"",value:"R$ ",credit:"R$ ",bonus:"R$ ",date:"",payment_via_id:"",note:"",sponsorship_client_id:"",is_sponsor:!1,is_shipping:!1,add_rest_to_credits:!1,use_client_balance:!1,use_client_bonus:!1}),maskCurrencyBRL:b({numeralPositiveOnly:!0}),maskDate:y,isLoading:!1}},computed:{paymentMatchesBankEntry(){return!this.isEdit||o(this.bank_entry)?!0:+this.payment.value==+this.bank_entry.value},isLoadingQuery(){return!!this.$apollo.queries.vias.loading},isFromBankEntry(){return!o(this.bank_entry)},orderRest(){const a=c(this.form.credit,",");return(this.order.total_owing-a).toFixed(2)},showEntriesInput(){return this.isEdit?this.payment.is_confirmed===null:!0}},watch:{vias:{handler(a){a.length&&this.$nextTick(()=>{this.populateForm()})},immediate:!0}},activated(){this.vias.length&&this.populateForm()},methods:{formatCurrencyBRL:r,populateForm(){if(!this.payment){this.form.payment_via_id="",this.form.note="";return}this.form.set({payment_via_id:this.payment.via.id,note:this.payment.note,date:p(this.payment.date)})},onPayRestClick(){this.form.value=this.$helpers.toBRL(this.orderRest)},getFormattedForm(){var e;const a=this.form.data();return a.sponsorship_client_id=((e=a.sponsorship_client_id)==null?void 0:e.id)||"",a},async create(){const a=this.getFormattedForm();try{await this.$apollo.mutate({mutation:_,variables:{input:{order_id:this.order.id,...a}},refetchQueries:[v],awaitRefetchQueries:!0}),this.bank_entry="",this.$helpers.clearCacheFrom([{fieldName:"clientBalances"},{fieldName:"entries"},{fieldName:"payments"},{fieldName:"cashFlowEntries"}]),i(this,{message:"Pagamento registrado!",resetForm:!0})}catch(e){n(this,e)}},async update(){const a=this.getFormattedForm();try{await this.$apollo.mutate({mutation:f,variables:{id:this.payment.id,input:{order_id:this.order.id,...a}}}),this.$helpers.clearCacheFrom({fieldName:"dailyCash"}),i(this,{message:"Pagamento atualizado!"})}catch(e){n(this,e)}},async onSubmit(){this.isLoading=!0,this.isEdit?await this.update():await this.create(),this.isLoading=!1},onSelectEntry(a){if(this.isEdit){this.form.set({bank_uid:a.bank_uid,payment_via_id:a.via_id,note:a.description});return}this.form.set({bank_uid:a.bank_uid,value:r(a.value),date:a.date,note:a.description,payment_via_id:a.via_id})},onIsShippingPaymentCheckbox(){this.form.add_rest_to_credits=!1},onIsSponsorValueChange(){this.form.use_client_balance=!1,this.form.use_client_bonus=!1},onUseBalanceChange(a){a&&(this.form.add_rest_to_credits=!1,this.form.is_sponsor=!1)}}};var C=function(){var e=this,t=e._self._c;return t("AppForm",{staticClass:"position-relative",attrs:{"on-submit":e.onSubmit,form:e.form}},[t("AppLoading",{directives:[{name:"show",rawName:"v-show",value:e.isLoadingQuery,expression:"isLoadingQuery"}]}),e.form.errors.get("bank_uid")?t("AppAlert",{attrs:{color:"warning",small:""}},[e._v(" "+e._s(e.form.errors.get("bank_uid"))+" ")]):e._e(),e.showEntriesInput?t("SelectEntriesFind",{on:{select:e.onSelectEntry},model:{value:e.bank_entry,callback:function(s){e.bank_entry=s},expression:"bank_entry"}}):e._e(),e.paymentMatchesBankEntry?e._e():t("div",{staticClass:"small text-danger mb-4"},[e._v(" O valor da entrada bancária e pagamento devem ser iguais. ")]),e.isEdit?e._e():[t("AppContainer",{staticClass:"mb-2",scopedSlots:e._u([{key:"title",fn:function(){return[e._v(" Valor de pagamento ")]},proxy:!0},{key:"body",fn:function(){return[e.form.is_sponsor?e._e():[e.order.client.balance&&!e.bank_entry?t("AppCheckbox",{attrs:{id:"clientCredit",name:"clientCredit",disabled:e.form.use_client_bonus},on:{input:e.onUseBalanceChange},model:{value:e.form.use_client_balance,callback:function(s){e.$set(e.form,"use_client_balance",s)},expression:"form.use_client_balance"}},[e._v(" Usar saldo do cliente ")]):e._e(),e.order.client.bonus>0&&!e.bank_entry?t("AppCheckbox",{attrs:{id:"clientBonus",name:"clientBonus",disabled:e.form.use_client_balance},on:{input:e.onUseBalanceChange},model:{value:e.form.use_client_bonus,callback:function(s){e.$set(e.form,"use_client_bonus",s)},expression:"form.use_client_bonus"}},[e._v(" Usar bônus do cliente ")]):e._e()],e.form.use_client_balance&&!e.bank_entry?t("AppInput",{key:"credit",attrs:{id:"credit",name:"credit",error:e.form.errors.get("credit"),mask:e.maskCurrencyBRL,numeric:"",disabled:e.isFromBankEntry},scopedSlots:e._u([{key:"hint",fn:function(){return[e.form.is_sponsor?e.form.sponsorship_client_id?[e._v(" Disponível: "),e.form.sponsorship_client_id?t("span",[e._v(" "+e._s(e.$helpers.toBRL(e.form.sponsorship_client_id.balance))+" ")]):e._e()]:[e._v(" Disponível: [selecione o patrocinador] ")]:[e._v(" Disponível: "+e._s(e.$helpers.toBRL(e.order.client.balance))+" ")]]},proxy:!0}],null,!1,3045289905),model:{value:e.form.credit,callback:function(s){e.$set(e.form,"credit",s)},expression:"form.credit"}},[e._v(" Valor a ser usado ")]):e._e(),e.form.use_client_bonus&&!e.bank_entry?t("AppInput",{key:"bonus",attrs:{id:"bonus",name:"bonus",error:e.form.errors.get("bonus"),mask:e.maskCurrencyBRL,numeric:"",disabled:e.isFromBankEntry},scopedSlots:e._u([{key:"hint",fn:function(){return[e.form.is_sponsor?e.form.sponsorship_client_id?[e._v(" Disponível: "),e.form.sponsorship_client_id?t("span",[e._v(" "+e._s(e.$helpers.toBRL(e.form.sponsorship_client_id.bonus))+" ")]):e._e()]:[e._v(" Disponível: [selecione o patrocinador] ")]:[e._v(" Disponível: "+e._s(e.$helpers.toBRL(e.order.client.bonus))+" ")]]},proxy:!0}],null,!1,43843313),model:{value:e.form.bonus,callback:function(s){e.$set(e.form,"bonus",s)},expression:"form.bonus"}},[e._v(" Valor a ser usado ")]):e._e(),!e.form.use_client_balance&&!e.form.use_client_bonus?t("AppInput",{key:"value",attrs:{id:"value",name:"value",error:e.form.errors.get("value"),mask:e.maskCurrencyBRL,numeric:"",disabled:e.isFromBankEntry},scopedSlots:e._u([{key:"append",fn:function(){return[t("AppButton",{attrs:{disabled:e.isFromBankEntry,outlined:"",tooltip:e.$helpers.toBRL(e.orderRest)},on:{click:function(s){return s.preventDefault(),e.onPayRestClick.apply(null,arguments)}}},[e._v(" Restante ")])]},proxy:!0}],null,!1,4023822601),model:{value:e.form.value,callback:function(s){e.$set(e.form,"value",s)},expression:"form.value"}},[e._v(" Valor ")]):e._e(),t("div",{staticClass:"d-flex align-items-center mb-3"},[t("AppCheckbox",{attrs:{id:"rest",name:"rest",disabled:e.form.is_shipping||e.form.use_client_bonus||e.form.use_client_balance,"default-margin":!1},model:{value:e.form.add_rest_to_credits,callback:function(s){e.$set(e.form,"add_rest_to_credits",s)},expression:"form.add_rest_to_credits"}},[e._v(" Adicionar resto ao saldo do "+e._s(e.form.is_sponsor?"patrocinador":"cliente")+" ")]),t("FontAwesomeIcon",{directives:[{name:"tippy",rawName:"v-tippy"}],staticClass:"text-secondary ms-2",attrs:{icon:e.icons.faQuestionCircle,content:"Caso o valor supere o que resta pagar"}})],1),t("AppCheckbox",{attrs:{id:"is_sponsor",disabled:e.form.use_client_bonus||e.form.use_client_balance,name:"is_sponsor"},on:{input:e.onIsSponsorValueChange},model:{value:e.form.is_sponsor,callback:function(s){e.$set(e.form,"is_sponsor",s)},expression:"form.is_sponsor"}},[e._v(" Patrocínio ")]),t("div",{staticClass:"d-flex align-items-center mb-3"},[t("AppCheckbox",{attrs:{id:"shipping_payment",name:"shipping_payment","default-margin":!1},on:{input:e.onIsShippingPaymentCheckbox},model:{value:e.form.is_shipping,callback:function(s){e.$set(e.form,"is_shipping",s)},expression:"form.is_shipping"}},[e._v(" Adicionar como frete ")]),t("FontAwesomeIcon",{directives:[{name:"tippy",rawName:"v-tippy"}],staticClass:"text-secondary ms-2",attrs:{icon:e.icons.faQuestionCircle,content:"O valor será somado ao preço final do pedido"}})],1),t("SelectClientsFind",{directives:[{name:"show",rawName:"v-show",value:e.form.is_sponsor,expression:"form.is_sponsor"}],attrs:{id:"sponsorship_client_id",error:e.form.errors.get("sponsorship_client_id")},model:{value:e.form.sponsorship_client_id,callback:function(s){e.$set(e.form,"sponsorship_client_id",s)},expression:"form.sponsorship_client_id"}},[e._v(" Cliente patrocinador ")])]},proxy:!0}],null,!1,425840248)})],t("AppInput",{attrs:{id:"date",placeholder:"dd/mm/aaaa",name:"date",type:"date",numeric:"","today-button":"",mask:e.maskDate,error:e.form.errors.get("date"),"disabled-message":e.form.is_sponsor?"Não é necessário informar a data em patrocínios":!1,disabled:e.isFromBankEntry},model:{value:e.form.date,callback:function(s){e.$set(e.form,"date",s)},expression:"form.date"}},[e._v(" Data de pagamento ")]),t("AppSimpleSelect",{attrs:{id:"payment_via_id",name:"payment_via_id",options:e.vias,"label-prop":"name","value-prop":"id",error:e.form.errors.get("payment_via_id")},model:{value:e.form.payment_via_id,callback:function(s){e.$set(e.form,"payment_via_id",s)},expression:"form.payment_via_id"}},[e._v(" Via ")]),t("AppInput",{attrs:{id:"note",name:"note",placeholder:"Anotação extra do pagamento...",error:e.form.errors.get("note")},model:{value:e.form.note,callback:function(s){e.$set(e.form,"note",s)},expression:"form.note"}},[e._v(" Observação ")]),t("div",{staticClass:"row mt-4"},[t("div",{staticClass:"col"},[t("AppButton",{staticClass:"fw-bold",attrs:{type:"submit",color:"success",block:"",loading:e.isLoading,disabled:!e.paymentMatchesBankEntry}},[e._v(" "+e._s(e.isEdit?"ATUALIZAR":"REGISTRAR")+" ")])],1),t("div",{staticClass:"col"},[t("AppButton",{attrs:{type:"button",color:"light",block:"","data-bs-dismiss":"modal"}},[e._v(" Cancelar ")])],1)])],2)},x=[],B=l(g,C,x,!1,null,null,null,null);const I=B.exports;export{I as default};
